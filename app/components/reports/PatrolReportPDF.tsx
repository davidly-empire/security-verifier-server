'use client';

import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable'; 

interface PatrolLocation {
  employee_name: string;
  employee_id: string;
  patrol_time: string;
  location: string;
  latitude: string;
  longitude: string;
}

interface PatrolRound {
  s_no: number;
  date: string;
  start_time: string;
  end_time: string;
  time_range_display: string; 
  status: string; 
  table: PatrolLocation[];
}

interface PatrolReportResponse {
  factory_name: string;
  factory_address: string;
  report_date: string;
  generated_by: string;
  generated_at: string;
  rounds: PatrolRound[];
}

interface PatrolReportPDFProps {
  reportData: PatrolReportResponse;
  factoryCode: string;
}

const PatrolReportPDF: React.FC<PatrolReportPDFProps> = ({ reportData, factoryCode }) => {
  
  const handleGeneratePDF = () => {
    const doc = new jsPDF();

    const pageWidth = doc.internal.pageSize.getWidth(); // Get width to calculate center

    // --- 1. HEADER SECTION (REDUCED SIZE & COMPACT) ---
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold"); 
    doc.text("Patrol Report", pageWidth / 2, 22, { align: "center" });

    doc.setFontSize(9);
    doc.setFont("helvetica", "normal"); 
    doc.setTextColor(100);
    
    doc.text(`Factory Name: ${reportData.factory_name}`, pageWidth / 2, 28, { align: "center" });
    doc.text(`Address: ${reportData.factory_address}`, pageWidth / 2, 34, { align: "center" });
    
    const dateStr = new Date(reportData.report_date).toLocaleDateString();
    const generatedStr = new Date(reportData.generated_at).toLocaleString();
    
    doc.text(`Report Date: ${dateStr}`, pageWidth / 2, 40, { align: "center" });
    doc.text(`Generated By: ${reportData.generated_by}`, pageWidth / 2, 46, { align: "center" });
    doc.text(`Generated At: ${generatedStr}`, pageWidth / 2, 52, { align: "center" });

    // --- 2. ROUNDS & SCANS LOOP ---
    let finalY = 58; 

    reportData.rounds.forEach((round) => {
      if (finalY > 250) {
        doc.addPage();
        finalY = 20;
      }

      // Round Title
      doc.setFontSize(12);
      doc.setFont("helvetica", "bold");
      doc.setTextColor(0);
      doc.text(`Round ${round.s_no}`, 14, finalY);
      
      // Round Subtitle (Times)
      doc.setFontSize(9);
      doc.setFont("helvetica", "normal");
      doc.setTextColor(100);
      const timeRangeText = round.time_range_display || "N/A";
      doc.text(`Time: ${timeRangeText}`, 14, finalY + 5);

      // --- LOGIC CHANGE: ALWAYS DRAW TABLE ---
      let tableBody: any[] = [];
      
      if (round.status === "SUCCESS") {
        // SUCCESS: Map actual data
        tableBody = round.table.map((scan) => [
          "SUCCESS",           // STATUS: SUCCESS
          scan.employee_name,     // Name
          scan.location,          // Location
          new Date(scan.patrol_time).toLocaleTimeString(), // Time
          `${scan.latitude}, ${scan.longitude}`,          // Coords
        ]);
      } else {
        // MISSED: Push NULL values + Status
        tableBody.push([
          "MISSED",          // STATUS: MISSED
          "-",                // Name: NULL
          "-",                // Location: NULL
          "-",                // Time: NULL
          "-",                // Coords: NULL
        ]);
      }

      // --- 3. DRAW TABLE ---
      // Added 'Status' to head
      autoTable(doc, {
        startY: finalY + 10,
        head: [['Status', 'Guard Name', 'Location', 'Time', 'Coords']],
        body: tableBody,
        theme: 'grid',
        headStyles: { fillColor: [59, 130, 246] }, // Blue header
        styles: { fontSize: 8 }, 
        columnStyles: {
           // Color the Status column specifically
           0: { fontStyle: 'bold', textColor: [0, 0, 0] } 
        },
      });

      // Move Y down
      finalY = (doc as any).lastAutoTable.finalY + 8;
    });

    // --- 4. SAVE FILE ---
    const fileName = `Patrol_Report_${factoryCode}_${reportData.report_date}.pdf`;
    doc.save(fileName);
  };

  return (
    <button
      onClick={handleGeneratePDF}
      className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded"
    >
      Generate & Download PDF
    </button>
  );
};

export default PatrolReportPDF;